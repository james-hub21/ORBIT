# Turbopack Build Investigation Log

## Error Details
```
SyntaxError: "undefined" is not valid JSON
    at JSON.parse (<anonymous>)
    at <unknown> (C:\code\ORBIT-v0.1\orbit-next\.next\server\chunks\[root-of-the-server]__98129c77._.js:34:89475)
    at Array.map (<anonymous>)
    at y.on (C:\code\ORBIT-v0.1\orbit-next\.next\server\chunks\[root-of-the-server]__98129c77._.js:34:89336)
    at module evaluation (C:\code\ORBIT-v0.1\orbit-next\.next\server\chunks\[root-of-the-server]__98129c77._.js:34:152151)
```

## Module Import Chain
1. Next.js build process starts
2. Turbopack collects page data for route: `/api/admin/activity`
3. Route imports: `@/server/auth` and `@/server/storage`
4. Storage imports: `@/server/db` (for database connection)
5. DB imports: `pg` driver and `drizzle-orm`
6. Schema imports: `drizzle-orm/pg-core`

## Problem Analysis

### Issue: pg driver's default type parser is being invoked BEFORE our custom parser
The pg driver has default type parsers that get registered when the module is first imported.
Our custom parser setup runs at module load time (line 30 in db.ts), but the issue is:

**The pg driver is being used during Turbopack's module evaluation/bundling phase**, not at runtime.

### Why `force-dynamic` doesn't help:
- `force-dynamic` prevents STATIC GENERATION of the route
- But Turbopack still needs to BUNDLE and EVALUATE modules to understand dependencies
- During this evaluation, if any code path actually QUERIES the database, it triggers the pg driver
- The driver uses its default JSON.parse on JSONB values

### The Real Culprit:
Looking at the stack trace: `at Array.map` and `at y.on` suggests this is happening during:
- A drizzle query result being processed
- The pg driver's result parser running on JSONB columns
- This happens EVEN during module evaluation if there's any code that runs at import time

## Hypothesis to Test
The issue might be that:
1. Some module is executing a database query at IMPORT TIME (not at request time)
2. OR Turbopack is trying to statically analyze query results
3. OR There's a circular dependency causing modules to load out of order
